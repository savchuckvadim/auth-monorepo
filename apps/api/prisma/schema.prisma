generator client {
    provider      = "prisma-client-js"
    output        = "../generated/prisma"
    binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
}

model User {
    id             String     @id @default(uuid())
    name           String     @db.VarChar(255)
    email          String     @unique(map: "users_email_unique") @db.VarChar(255)
    isAcivated     Boolean    @default(false)
    activationLink String     @unique(map: "users_activation_link_unique") @db.VarChar(255)
    role           user_roles
    password       String
    createdAt      DateTime?  @default(now())
    updatedAt      DateTime?  @default(now())
    tokens         Token[]

    // Messenger relations
    createdChats  Chat[]              @relation("ChatCreator")
    chatMembers   ChatMember[]
    messages      Message[]
    sentCalls     Call[]              @relation("CallInitiator")
    receivedCalls Call[]              @relation("CallReceiver")
    messageReads  MessageReadStatus[]
    chats         Chat[]

    // Followers relations
    followers Follow[] @relation("UserFollowers")
    following Follow[] @relation("UserFollowing")

    @@unique([email])
    @@map("users")
}

model Token {
    id           String @id @default(uuid())
    userId       String @map("user_id") @db.VarChar(255)
    refreshToken String @map("refresh_token") @db.VarChar(255)

    createdAt DateTime? @default(now())
    updatedAt DateTime? @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@map("tokens")
}

enum user_roles {
    owner
    admin
    user
}

// Messenger models

model Chat {
    id          String   @id @default(uuid())
    type        ChatType @default(PRIVATE)
    name        String?  @db.VarChar(255) // Для групповых чатов
    description String?  @db.Text // Для групповых чатов
    avatar      String?  @db.VarChar(500) // URL аватара
    createdBy   String   @map("created_by") @db.VarChar(255)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    members  ChatMember[]
    messages Message[]
    calls    Call[]

    creator User    @relation("ChatCreator", fields: [createdBy], references: [id], onDelete: Cascade)
    user    User?   @relation(fields: [userId], references: [id])
    userId  String?

    @@index([type])
    @@index([createdAt])
    @@map("chats")
}

model ChatMember {
    id         String         @id @default(uuid())
    chatId     String         @map("chat_id") @db.VarChar(255)
    userId     String         @map("user_id") @db.VarChar(255)
    role       ChatMemberRole @default(MEMBER)
    joinedAt   DateTime       @default(now()) @map("joined_at")
    leftAt     DateTime?      @map("left_at")
    lastReadAt DateTime?      @map("last_read_at")

    chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([chatId, userId])
    @@index([userId])
    @@index([chatId])
    @@map("chat_members")
}

model Message {
    id        String      @id @default(uuid())
    chatId    String      @map("chat_id") @db.VarChar(255)
    senderId  String      @map("sender_id") @db.VarChar(255)
    content   String      @db.Text
    type      MessageType @default(TEXT)
    fileUrl   String?     @map("file_url") @db.VarChar(500)
    fileName  String?     @map("file_name") @db.VarChar(255)
    fileSize  Int?        @map("file_size")
    replyToId String?     @map("reply_to_id") @db.VarChar(255)
    editedAt  DateTime?   @map("edited_at")
    deletedAt DateTime?   @map("deleted_at")
    createdAt DateTime    @default(now())
    updatedAt DateTime    @updatedAt

    chat       Chat                @relation(fields: [chatId], references: [id], onDelete: Cascade)
    sender     User                @relation(fields: [senderId], references: [id], onDelete: Cascade)
    replyTo    Message?            @relation("MessageReply", fields: [replyToId], references: [id], onDelete: SetNull)
    replies    Message[]           @relation("MessageReply")
    readStatus MessageReadStatus[]

    @@index([chatId, createdAt])
    @@index([senderId])
    @@index([replyToId])
    @@map("messages")
}

model MessageReadStatus {
    id        String   @id @default(uuid())
    messageId String   @map("message_id") @db.VarChar(255)
    userId    String   @map("user_id") @db.VarChar(255)
    readAt    DateTime @default(now()) @map("read_at")

    message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([messageId, userId])
    @@index([userId])
    @@index([messageId])
    @@map("message_read_status")
}

model Call {
    id          String     @id @default(uuid())
    chatId      String     @map("chat_id") @db.VarChar(255)
    initiatorId String     @map("initiator_id") @db.VarChar(255)
    receiverId  String?    @map("receiver_id") @db.VarChar(255)
    type        CallType   @default(VIDEO)
    status      CallStatus @default(INITIATED)
    startedAt   DateTime?  @map("started_at")
    endedAt     DateTime?  @map("ended_at")
    duration    Int? // Длительность в секундах
    createdAt   DateTime   @default(now())

    chat      Chat  @relation(fields: [chatId], references: [id], onDelete: Cascade)
    initiator User  @relation("CallInitiator", fields: [initiatorId], references: [id], onDelete: Cascade)
    receiver  User? @relation("CallReceiver", fields: [receiverId], references: [id], onDelete: SetNull)

    @@index([chatId])
    @@index([initiatorId])
    @@index([status])
    @@map("calls")
}

enum ChatType {
    PRIVATE
    GROUP
}

enum ChatMemberRole {
    OWNER
    ADMIN
    MEMBER
}

enum MessageType {
    TEXT
    IMAGE
    VIDEO
    AUDIO
    FILE
    SYSTEM
}

enum CallType {
    AUDIO
    VIDEO
}

enum CallStatus {
    INITIATED
    RINGING
    ACCEPTED
    REJECTED
    MISSED
    ENDED
}

// Followers model

model Follow {
    id          String   @id @default(uuid())
    followerId  String   @map("follower_id") @db.VarChar(255)
    followingId String   @map("following_id") @db.VarChar(255)
    createdAt   DateTime @default(now())

    follower  User @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
    following User @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

    @@unique([followerId, followingId])
    @@index([followerId])
    @@index([followingId])
    @@map("follows")
}
