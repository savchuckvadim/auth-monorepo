# Auth Monorepo

–ú–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ backend (NestJS) –∏ frontend (React/Next.js).

## üìö –û–±—É—á–∞—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- **–û–±—É—á–∞—é—â–µ–µ –≤–∏–¥–µ–æ**: https://www.youtube.com/watch?v=fN25fMQZ2v0
- **Backend —á–∞—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞**: https://itbooster.ru/pet-projects/4/details/

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

–ü—Ä–æ–µ–∫—Ç –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω –∫–∞–∫ –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º pnpm workspaces –∏ Turbo:

```
auth-mono/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ api/          # Backend –Ω–∞ NestJS
‚îÇ   ‚îî‚îÄ‚îÄ front/        # Frontend –Ω–∞ Next.js/React
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ ui/           # –û–±—â–∏–µ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (shadcn/ui)
‚îÇ   ‚îú‚îÄ‚îÄ nest-api/     # API –∫–ª–∏–µ–Ω—Ç –¥–ª—è frontend
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ docker/           # Dockerfile'—ã –¥–ª—è —Å–±–æ—Ä–∫–∏
‚îú‚îÄ‚îÄ docker-compose.yml        # Production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îî‚îÄ‚îÄ docker-compose-dev.yml    # Development –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```

## üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (Development)

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (MySQL –∏ Redis):

```bash
docker-compose -f docker-compose-dev.yml up -d --build
```

–≠—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç:
- **MySQL** –Ω–∞ –ø–æ—Ä—Ç—É `3310` (–ª–æ–∫–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `127.0.0.1:3310`)
- **Redis** –Ω–∞ –ø–æ—Ä—Ç—É `6334` (–ª–æ–∫–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `127.0.0.1:6334`)

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pnpm install

# –ó–∞–ø—É—Å–∫ backend –∏ frontend –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
pnpm dev
```

### Production

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ production —Ä–µ–∂–∏–º–µ —Å–æ –≤—Å–µ–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ –≤ Docker:

```bash
docker-compose -f docker-compose.yml up -d --build
```

–≠—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç:
- **Frontend** –Ω–∞ –ø–æ—Ä—Ç—É, —É–∫–∞–∑–∞–Ω–Ω–æ–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `PORT_FRONT`
- **Backend API** –Ω–∞ –ø–æ—Ä—Ç—É `3000`
- **MySQL** –Ω–∞ –ø–æ—Ä—Ç—É `3310`
- **Redis** –Ω–∞ –ø–æ—Ä—Ç—É `6334`

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ Frontend (React)

### –°—Ç—Ä–∞–Ω–∏—Ü—ã

1. **–§–æ—Ä–º–∞ –ª–æ–≥–∏–Ω–∞** (`/auth/login`)
   - –ü–æ–ª—è: email + password
   - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: `apps/front/modules/processes/auth/ui/components/login-form.tsx`

2. **–§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏** (`/auth/register`)
   - –ü–æ–ª—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

3. **–ó–∞—â–∏—â—ë–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞/–ø–∞–Ω–µ–ª—å** (`/network` –∏–ª–∏ –¥—Ä—É–≥–∞—è)
   - –í–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
   - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ middleware –∏ HOC/–∫–æ–º–ø–æ–Ω–µ–Ω—Ç-–∑–∞—â–∏—Ç—É —Ä–æ—É—Ç–æ–≤

### –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

#### accessToken
- –•—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ (React state / context) –∏–ª–∏ –≤ `localStorage`
- ‚ö†Ô∏è –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `localStorage` —É—á–∏—Ç—ã–≤–∞–π—Ç–µ —Ä–∏—Å–∫–∏ XSS-–∞—Ç–∞–∫

#### refreshToken
- **–ù–ï —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ JavaScript**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `HttpOnly cookie` (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—Ä–∞—É–∑–µ—Ä–æ–º –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### 1. Next.js Middleware –¥–ª—è –∑–∞—â–∏—Ç—ã —Ä–æ—É—Ç–æ–≤

–î–ª—è –∑–∞—â–∏—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **Next.js Middleware** (`apps/front/middleware.ts`), –∫–æ—Ç–æ—Ä—ã–π:
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `accessToken` –≤ cookie
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–π—Ç–∏ –Ω–∞ –∑–∞—â–∏—â—ë–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, `/network`) ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/auth/login`
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –∑–∞—â–∏—â—ë–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (`/network`)

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è middleware:
- –ó–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
- –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ HOC –∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö-–æ–±—ë—Ä—Ç–∫–∞—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∑–∞—â–∏—â—ë–Ω–Ω—ã–º –º–∞—Ä—à—Ä—É—Ç–∞–º

#### 2. –ò–Ω—Ç–µ—Ä—Ü–µ–ø—Ç–æ—Ä—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤

–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω—Ç–µ—Ä—Ü–µ–ø—Ç–æ—Ä—ã HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤:

**Request Interceptor:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <accessToken>` –∫–æ –≤—Å–µ–º –∑–∞–ø—Ä–æ—Å–∞–º

**Response Interceptor:**
- –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ `401 Unauthorized`:
  1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ `refreshToken` (–≤ HttpOnly cookie)
  2. –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ `/auth/refresh`
  3. –ü–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π `accessToken`
  4. –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
  5. –ï—Å–ª–∏ refresh –Ω–µ —É–¥–∞–ª—Å—è ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ UI

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç shadcn/ui –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ –ø–∞–∫–µ—Ç–∞ `@workspace/ui`:

```tsx
import { Input } from "@workspace/ui/components/input";
import { Alert } from "@workspace/ui/components/alert";
import { AlertDescription } from "@workspace/ui/components/alert";
import { Button } from "@workspace/ui/components/button";
```

## üîß –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend
- **NestJS** - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è Node.js
- **Prisma** - ORM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- **MySQL** - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Redis** - –∫—ç—à –∏ –æ—á–µ—Ä–µ–¥–∏

### Frontend
- **Next.js** - React —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **React** - UI –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
- **shadcn/ui** - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI
- **Redux Toolkit** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
- **TanStack Query** - —Ä–∞–±–æ—Ç–∞ —Å API

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- **Docker** & **Docker Compose** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- **pnpm** - –º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–∫–µ—Ç–æ–≤
- **Turbo** - —Å–±–æ—Ä–∫–∞ –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

## üìù –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### Backend (apps/api)

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ `apps/api/`:

```env
DATABASE_URL="mysql://root:cf@localhost:3310/auth-monorepo"
REDIS_HOST=localhost
REDIS_PORT=6334
JWT_SECRET=your-secret-key
JWT_REFRESH_SECRET=your-refresh-secret-key
```

### Frontend (apps/front)

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env.local` –≤ `apps/front/`:

```env
NEXT_PUBLIC_API_URL=http://localhost:3000
```

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ú–∏–≥—Ä–∞—Ü–∏–∏ Prisma

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
cd apps/api
npx prisma migrate dev

# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client
npx prisma generate
```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î

- **Host**: `localhost`
- **Port**: `3310`
- **Database**: `auth-monorepo`
- **User**: `root`
- **Password**: `cf`

## üîê API Endpoints

–û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

- `POST /auth/login` - –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
- `POST /auth/register` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- `POST /auth/refresh` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ access token
- `POST /auth/logout` - –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
- `GET /auth/me` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –≤—Å–µ–≥–æ –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
pnpm install
```

## üõ†Ô∏è –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
pnpm dev

# –°–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
pnpm build

# –õ–∏–Ω—Ç–∏–Ω–≥
pnpm lint

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
pnpm format
```

## üê≥ Docker —Å–µ—Ä–≤–∏—Å—ã

### Development (docker-compose-dev.yml)

- `db-auth-monorepo` - MySQL 8.0
- `redis-auth-monorepo` - Redis 7

### Production (docker-compose.yml)

- `front-auth-monorepo` - Frontend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- `api-auth-monorepo` - Backend API
- `db-auth-monorepo` - MySQL 8.0
- `redis-auth-monorepo` - Redis 7

## üìñ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –æ–¥–Ω–æ–π Docker —Å–µ—Ç–∏ `app-network`
- –î–∞–Ω–Ω—ã–µ –ë–î —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `apps/api/db_data/`
- –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `./logs/`
