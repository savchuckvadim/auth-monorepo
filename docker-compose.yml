version: "3.8"

services:
  front-auth-monorepo:
    build:
      context: .
      dockerfile: docker/Front.Dockerfile
      args:
        APP: front
        # URL –±—ç–∫–µ–Ω–¥–∞ –±–µ—Ä–µ—Ç—Å—è –∏–∑ .env —Ñ–∞–π–ª–∞ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
        # –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç (—Ç–æ–ª—å–∫–æ –¥–ª—è build)
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:7000}
    container_name: front-auth-monorepo
    ports:
      - "7001:3000"
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
    env_file:
      - .env
    environment:
      - LOG_FILE_PATH=/app/logs/server.log
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - app-network

  api-auth-monorepo:
    build:
      context: .
      dockerfile: docker/Back.Dockerfile
    container_name: api-auth-monorepo
    ports:
      - "7000:3000"
    environment:
      - NODE_ENV=production
      # –í–Ω—É—Ç—Ä–∏ Docker —Å–µ—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ—Ä—Ç—ã –∏ –∏–º–µ–Ω–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
      # –í–Ω–µ—à–Ω–∏–µ –ø–æ—Ä—Ç—ã (3317, 7034) –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ —Å —Ö–æ—Å—Ç–∞
      - REDIS_HOST=redis-auth-monorepo
      - REDIS_PORT=6379 # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç Redis (–≤–Ω–µ—à–Ω–∏–π 7034 —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ —Å —Ö–æ—Å—Ç–∞)
      - PORT=3000
      - DATABASE_URL=mysql://root:cf@db-auth-monorepo:3306/auth-monorepo # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç MySQL (–≤–Ω–µ—à–Ω–∏–π 3317 —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ —Å —Ö–æ—Å—Ç–∞)
    depends_on:
      db-auth-monorepo:
        condition: service_healthy
      redis-auth-monorepo:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./apps/api/src:/app/src # üîÅ –ú–æ–Ω—Ç–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫–∏
      - ./apps/api/tsconfig.json:/app/tsconfig.json
      - ./apps/api/nest-cli.json:/app/nest-cli.json
      - ./apps/api/storage:/app/storage
    networks:
      - app-network

  redis-auth-monorepo:
    image: redis:7
    container_name: redis-auth-monorepo
    # –ü–æ—Ä—Ç –Ω–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞—Ä—É–∂—É - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Docker —Å–µ—Ç–∏
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    networks:
      - app-network

  db-auth-monorepo:
    image: mysql:8.0
    container_name: db-auth-monorepo
    restart: "unless-stopped"
    environment:
      MYSQL_ROOT_PASSWORD: cf # –ó–∞–¥–∞–π —Å–≤–æ–π –ø–∞—Ä–æ–ª—å –¥–ª—è root
      MYSQL_DATABASE: auth-monorepo # –ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      # MYSQL_USER: root # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      MYSQL_PASSWORD: cf # –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # –ü–æ—Ä—Ç –Ω–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞—Ä—É–∂—É - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Docker —Å–µ—Ç–∏
    volumes:
      - ./apps/api/db_data:/var/lib/mysql
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p$$MYSQL_ROOT_PASSWORD",
        ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - app-network

networks:
  app-network:
    driver: bridge



# docker-compose stop api-auth-monorepo
# docker-compose up -d --build api-auth-monorepo
