version: "3.8"

services:
  front-auth-monorepo:
    build:
      context: .
      dockerfile: docker/Front.Dockerfile
      args:
        APP: front
    container_name: front-auth-monorepo
    ports:
      - "${PORT_FRONT}:5000"
    environment:
      - LOG_FILE_PATH=/app/logs/server.log
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - app-network

  api-auth-monorepo:
    build:
      context: .
      dockerfile: docker/Back.Dockerfile
    container_name: api-auth-monorepo
    ports:
      - "${PORT_BACK}:3000"
    environment:
      - NODE_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=${REDIS_PORT}
      - PORT=${PORT_BACK} # –¥–ª—è app.listen
    depends_on:
      redis-auth-monorepo:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./apps/api/src:/app/src # üîÅ –ú–æ–Ω—Ç–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫–∏
      - ./apps/api/tsconfig.json:/app/tsconfig.json
      - ./apps/api/nest-cli.json:/app/nest-cli.json
      - ./apps/api/storage:/app/storage
    networks:
      - app-network

  redis-auth-monorepo:
    image: redis:7
    container_name: redis-auth-monorepo
    ports:
      - "${REDIS_PORT}:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    networks:
      - app-network

  db-auth-monorepo:
    image: mysql:8.0
    container_name: db-auth-monorepo
    restart: "unless-stopped"
    environment:
      MYSQL_ROOT_PASSWORD: cf # –ó–∞–¥–∞–π —Å–≤–æ–π –ø–∞—Ä–æ–ª—å –¥–ª—è root
      MYSQL_DATABASE: auth-monorepo # –ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      # MYSQL_USER: root # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      MYSQL_PASSWORD: cf # –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ports:
      - "${PORT_DB}:3306"
    volumes:
      - ./apps/api/db_data:/var/lib/mysql
      # - ./apps/api/db_dev:/docker-entrypoint-initdb.d
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
